import{execSync as e}from"child_process";import r from"path";import{copyFolderToLocal as t}from"jnu-cloud";import{PLATFORM as o,makeDir as i,saveFile as n,loadEnv as s,findFiles as l,findFolders as c,deleteFilesInFolder as p,substituteInFile as a}from"jnu-abc";import{findGithubAccount as m}from"./git.js";import{githubEnv as d}from"./env.js";import $ from"fs";let u="jd-environments/Templates",f={encoding:"utf8",shell:"win32"===process.platform?"cmd.exe":"/bin/sh"},h=()=>"win"===o?(e("chcp 65001>nul",{shell:"cmd.exe"}),e("cd",f).toString().trim().replace(/\\/g,"/")):e("pwd",f).toString().trim(),g=()=>"win"===o?(e("chcp 65001>nul",{shell:"cmd.exe"}),r.dirname(e("cd",f).toString().trim().replace(/\\/g,"/"))):r.dirname(e("pwd",f).toString().trim()),w=e=>e.endsWith("/")?"*/"+e+"*":"*/"+e,x=(e,r,t)=>{let o=s(`${e}/.env.${r}`);if(o){let i=Object.entries(o).map(([e,r])=>({[`{{${e}}}`]:String(r)})).reduce((e,r)=>({...e,...r}),{});a(`${e}/${"win"===r?"publish.bat":"publish.sh"}`,{...t,...i})}},_=r=>{let t=e(r,{encoding:"utf8"});return t?t.toString().trim():""},b=e=>{let r=[];return e.forEach(e=>r.push(_(e))),r},j=async(r,i=o,n="github")=>{let{template:s,repoName:l,userName:c,description:p}=r,{fullName:$,email:w}=await m(c??""),_=g(),b=h(),j="";if("github"===n)await t(u,l,d);else if("local"===n){let r=process.env.DEV_ROOT?`${process.env.DEV_ROOT}/${u}`:"C:/JnJ/Developments/jd-environments/Templates";"win"===i?e(j=`xcopy "${r}\\${s}" "${l}\\" /E /I /H /Y`,f):e(j=`cp -r ${r}/${s} ${l}`,f)}let y=[`${l}/package.json`,`${l}/README.md`,`${l}/docs/workflow.md`,`${l}/manifest.json`,`${l}/publish.sh`,`${l}/publish.bat`],v={"{{name}}":l??"","{{project-name}}":l??"","{{author}}":`${$} <${w}>`,"{{github-id}}":c??"","{{description}}":p||"","{{parent-dir}}":_,"{{current-dir}}":b};for(let e of y)a(e,v);if(!s.includes("simple"))for(let e of["win","mac"])x(l,e,v);return console.log(j=`cd ${b}/${l} && npm install`),e(j,f),console.log(j=`cd ${b}/${l} && xgit -e makeRepo -u ${c} -n ${l} -d "${p}"`),e(j,f),r},y=r=>(e(`xgit -e deleteRemoteRepo -u ${r.userName} -n ${r.repoName}`,f),"win"===o?e(`rmdir /s /q ${r.repoName}`,f):e(`rm -rf ${r.repoName}`,f),r),v=async e=>{let{template:r,repoName:t,userName:o,description:i}=e;switch(r){case"node-simple":case"python-pipenv":break;case"ts-swc-npm":case"ts-swc-simple":case"ts-webpack-obsidianPlugin":await j(e)}return e},E=(t,i)=>{try{let n=r.resolve(t),s=r.basename(n),l=r.dirname(n),c=process.cwd();if("win"===o)try{process.chdir(l);let r=`${s}_temp`;for(let t of(e(`xcopy "${s}" "${r}\\" /E /I /H /Y`,f),i?i.split(","):["node_modules","package-lock.json","package.json"])){let o=`${r}/${t}`;try{t.includes("/")?e(`rmdir /s /q "${o}"`,f):e(`del /q "${o}"`,f)}catch(e){console.log(`Warning: Could not remove ${t}`)}}e(`powershell -Command "Compress-Archive -Path '${r}/*' -DestinationPath '${s}.zip' -Force"`,f),e(`rmdir /s /q "${r}"`,f)}catch(e){throw console.error("Error during zip operation:",e),e}finally{process.chdir(c)}else try{process.chdir(l);let r=i?i.split(",").map(e=>`"${w(e)}"`).join(" "):'"*/node_modules/*" ".git/*"';e(`zip -r "${s}.zip" "${s}" -x ${r}`,f)}finally{process.chdir(c)}return{folderPath:t,excluded:i}}catch(e){throw console.error("Error in zip function:",e),e}},S=(t,o="__MACOSX/,node_modules/,.DS_Store,.git/")=>{let n=h(),s=[];for(let p of l(t,"*.zip"))try{let t;let l=`${n}/_unzip/${r.parse(p).name}`;if(console.log(`## extractPath: ${l}`),i(l),"win32"===process.platform)for(let i of(t=`powershell -command "Expand-Archive -Path '${p}' -DestinationPath '${l}' -Force"`,o.split(",").map(e=>e.trim()))){let t=r.join(l,i.replace("/",""));i.endsWith("/")?e(`if exist "${t}" rmdir /s /q "${t}"`,f):e(`if exist "${t}" del /q "${t}"`,f)}else{let e=o.split(",").map(e=>`"${e.trim()}"`).join(" ");t=`unzip -o "${p}" -d "${l}" -x ${e}`}e(t),console.log(`압축 해제 완료: ${p} -> ${l}`);let a=c(l).filter(e=>!e.includes("__MACOSX"));if(console.log(`### subFolders: ${a}, subFolders.length: ${a.length}, ${a[0]}`),1===a.length&&a[0].replace(l,"").includes(r.parse(p).name)){for(let t of(console.log(`### 중복 폴더 처리 필요: ${a}`),$.readdirSync(a[0]))){let o=r.join(a[0],t),i=r.join(l,t);"win32"===process.platform?e(`move "${o}" "${i}"`,f):e(`mv "${o}" "${i}"`,f)}"win32"===process.platform?e(`rmdir /s /q "${a[0]}"`,f):e(`rm -rf "${a[0]}"`,f)}s.push(l)}catch(e){console.error(`'${p}' 압축 해제 중 오류 발생:`,e.message)}return p(n,"__MACOSX/",!0),s.join(",")},C=r=>{{if("win"===o){let t=r.split(",").join("|")||"node_modules|dist|_backups|_drafts|types|docs";try{let r=`powershell -NoProfile -ExecutionPolicy Bypass -Command "$OutputEncoding = [Console]::OutputEncoding = [Text.Encoding]::UTF8; tree /F /A | Select-String -NotMatch '${t}'"`;console.log("Command: ",r);let o=e(r,{encoding:"utf8",stdio:"pipe"});return console.log("Result: ",o),o&&n("tree.txt",o,{overwrite:!0,newFile:!1,encoding:"utf8"}),o||""}catch(e){return console.error("Error executing tree command:",e),""}}let t=r?`"${r.split(",").join("|")}"`:'"node_modules|dist|_backups|_drafts|types|docs"',i=`tree -I ${t} --dirsfirst -L 3`;try{console.log("Command: ",i);let r=e(i,{encoding:"utf8",stdio:"pipe"});return r&&n("tree.txt",r,{overwrite:!0,newFile:!1}),r||""}catch(e){return console.error("Error executing tree command:",e),""}}};export{o as PLATFORM,f as execOptions,_ as exec,b as exe,g as getParentDir,h as getCurrentDir,v as initApp,y as removeApp,E as zip,C as tree,S as unzip};