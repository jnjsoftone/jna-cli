import e from"path";import{execSync as o}from"child_process";import{sleep as t,loadJson as r}from"jnu-abc";import{readJsonFromGithub as i}from"jnu-cloud";import{PLATFORM as n}from"./cli.js";import{githubEnv as c,localEnvRoot as s}from"./env.js";let l=(e,r={})=>{let{wait:i=0,msg:n="",echo:c=!0}=r;c&&(n=n||e,console.log(`Command: ${n}`));try{o(e),t(i)}catch(e){console.log("EXEC Error: ",e)}},a=async(e,o="github")=>{let{ENV_GITHUB_OWNER:t,ENV_GITHUB_REPO:n,ENV_GITHUB_TOKEN:c}=process.env,l={owner:process.env.ENV_GITHUB_OWNER||"",repo:process.env.ENV_GITHUB_REPO||"",token:process.env.ENV_GITHUB_TOKEN||""};try{if("local"===o){let o=await r(`${s}/Apis/github.json`);return o?.[e]}if("github"===o){let o=await i("Apis/github.json",l);return o?.[e]}return}catch(e){if(console.error("GitHub 계정 정보를 가져오는 중 오류가 발생했습니다:",e),process.env.ENV_GITHUB_OWNER&&process.env.ENV_GITHUB_TOKEN)return{userName:process.env.ENV_GITHUB_OWNER,fullName:process.env.ENV_GITHUB_OWNER,email:process.env.ENV_GITHUB_EMAIL??"",token:process.env.ENV_GITHUB_TOKEN};return}},g=async e=>{try{return(await e.rest.repos.listForAuthenticatedUser({per_page:100,sort:"updated"})).data}catch(e){throw e}},m=(e,o)=>{console.log("####@@@@@ createRemoteRepo options: ",o);let{name:t,description:r,isPrivate:i}=o;return e.rest.repos.createForAuthenticatedUser({name:t,description:r,private:i,auto_init:!0})},p=(e,o,t)=>{let{name:r}=o;return console.log(`### deleteRemoteRepo: ${r}`),e.rest.repos.delete({owner:t.userName,repo:r})},u=(e,o,t)=>{let r=`cd ${t} && git config user.name "${o.fullName}"`;l(r+=` && git config user.email "${o.email}" && git remote set-url origin https://${o.token}@github.com/${o.userName}/${e.name}.git`)},d=async(e,o,t)=>{let{name:r}=e,{fullName:i,email:n,token:c,userName:s}=o,a="";l(`cd ${t} && git init && git config --global --add safe.directory ${t}`,{wait:1});try{l(`cd ${t} && git branch -m master main`,{wait:2})}catch(e){console.log("####@@@@@===== error: ",e)}a=`cd ${t} && git config user.name "${i}" && git config user.email "${n}" && git remote add origin https://${c}@github.com/${s}/${r}.git`;let g=e.description||"Initial commit";l(a+=` && git add . && git commit -m "${g}"`,{wait:10})},$=(o,t,r)=>{l(`cd ${e.dirname(r)} && git clone https://${t.token}@github.com/${t.userName}/${o.name}.git`)},h=(e,o,r,i)=>{let n=`xgit -e createRemoteRepo -u ${r.userName} -n ${o.name} -d "${o.description}" -p ${o.isPrivate}`;l(n,{wait:10,msg:`initRepo ${n}`}),$(o,r,i),t(5),u(o,r,i)},f=(e,o,r)=>{$(e,o,r),t(10),u(e,o,r)},R=(e,t,r)=>{if(o(`cd ${r} && git status --porcelain`,{encoding:"utf8"}).length>0){let o=e.description||"Initial commit",t=`cd ${r} && git add . && git commit -m "${o}"`;l(t,{msg:`pushRepo ${t}`})}let i=o(`cd ${r} && git branch`);console.log(`#### pushRepo branches: ${i}`),i.includes("main")?l(`cd ${r} && git push -u origin main --force`):i.includes("master")?l(`cd ${r} && git push -u origin master --force`):console.log("main 또는 master 브랜치가 없습니다.")},y=(e,o,r,i)=>{console.log("####@@@@@===== makeRepo options: ",JSON.stringify(o)),l(`xgit -e createRemoteRepo -u ${r.userName} -n ${o.name} -d "${o.description}" -p ${o.isPrivate}`,{wait:10}),console.log(`=================== initLocalRepo: ${i}`),d(o,r,i),t(15),console.log(`=================== pushRepo: ${i}`),R(o,r,i)},b=(o,r,i,c)=>{p(o,r,i),t(10);let{name:s}=r;if("win"===n)try{let o=`cd ${e.dirname(c)}`;l(o);let t=`rmdir /s /q ${s}`;l(t)}catch(e){console.error("Failed to remove directory:",e);try{let e=`rd /s /q "${c}"`;l(e)}catch(e){console.error("Alternative removal also failed:",e)}}else l(`cd ${e.dirname(c)} && rm -rf ${s}`)},N=(e,t,r)=>{try{let e=o(`cd ${r} && git rev-parse --abbrev-ref HEAD`,{encoding:"utf8"}).trim();console.log(`📥 Pulling latest changes from ${e} branch...`);let t=`cd ${r} && git pull origin ${e}`;l(t,{msg:`pullRepo: ${t}`}),console.log("✅ Pull completed successfully!")}catch(e){throw console.error("❌ Pull failed:",e),e}},E=(e,t,r)=>{try{console.log("🔄 Starting repository synchronization...");let t=o(`cd ${r} && git rev-parse --abbrev-ref HEAD`,{encoding:"utf8"}).trim();if(console.log(`📍 Current branch: ${t}`),o(`cd ${r} && git status --porcelain`,{encoding:"utf8"}).length>0){console.log("📝 Local changes detected, committing...");let o=e.description||`Auto-sync: ${new Date().toISOString()}`,t=`cd ${r} && git add . && git commit -m "${o}"`;l(t,{msg:`syncRepo commit: ${t}`})}else console.log("📋 No local changes to commit");console.log("📥 Fetching from remote..."),l(`cd ${r} && git fetch origin ${t}`,{msg:"syncRepo fetch"});try{let e=o(`cd ${r} && git rev-list --count HEAD..origin/${t}`,{encoding:"utf8"}).trim(),i=o(`cd ${r} && git rev-list --count origin/${t}..HEAD`,{encoding:"utf8"}).trim();console.log(`📊 Repository status: ${i} commits ahead, ${e} commits behind`),parseInt(e)>0&&(console.log("📥 Pulling remote changes..."),l(`cd ${r} && git pull origin ${t}`,{msg:"syncRepo pull"})),parseInt(i)>0&&(console.log("📤 Pushing local changes..."),l(`cd ${r} && git push origin ${t}`,{msg:"syncRepo push"})),0===parseInt(e)&&0===parseInt(i)?console.log("✅ Repository is already up to date!"):console.log("✅ Synchronization completed successfully!")}catch(e){console.log("📤 Pushing to remote (first time)..."),l(`cd ${r} && git push -u origin ${t}`,{msg:"syncRepo initial push"}),console.log("✅ Initial push completed successfully!")}}catch(e){throw console.error("❌ Sync failed:",e),e}},v=async(e="github")=>{try{if("local"===e)return await r(`${s}/Apis/github.json`);if("github"===e)return await i("Apis/github.json",c);return}catch(e){console.error("GitHub 사용자 목록을 가져오는 중 오류가 발생했습니다:",e);return}};export{a as findGithubAccount,v as findAllUsers,g as findAllRepos,m as createRemoteRepo,p as deleteRemoteRepo,$ as cloneRepo,u as setLocalConfig,d as initLocalRepo,h as initRepo,f as copyRepo,R as pushRepo,y as makeRepo,b as removeRepo,N as pullRepo,E as syncRepo};