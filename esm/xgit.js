#!/usr/bin/env node
import{Octokit as e}from"@octokit/rest";import o from"yargs";import{saveFile as t,saveJson as a,makeDir as s}from"jnu-abc";import{findAllRepos as r,findAllUsers as i,findGithubAccount as c,createRemoteRepo as n,setLocalConfig as l,cloneRepo as p,initLocalRepo as m,deleteRemoteRepo as d,initRepo as u,copyRepo as g,pushRepo as N,makeRepo as $,removeRepo as f,pullRepo as b,syncRepo as h}from"./git.js";import{getCurrentDir as y}from"./cli.js";import v from"path";let R=o.usage("Usage: -e <exec> -u <userName> -n <repoName> -d <description> -p <isPrivate> -l <location>").option("e",{alias:"exec",default:"copyRepo",describe:"exec command: copyRepo(clone+config)/makeRepo(create+push)/removeRepo(delete)/pull(fetch latest)/sync(auto commit+push+pull)/list(repos)/userlist(users)",type:"string",demandOption:!0}).option("u",{alias:"userName",default:"mooninlearn",describe:"Name of User",type:"string"}).option("n",{alias:"repoName",describe:"NameOfRepository",type:"string"}).option("p",{alias:"isPrivate",default:!1,describe:"Private Repository",type:"boolean"}).option("s",{alias:"src",default:"local",describe:"Source of Github Account",type:"string"}).option("d",{alias:"description",describe:"Description For Repository",type:"string"}).option("l",{alias:"location",default:"./",describe:'For list command: output file paths (comma-separated, e.g., "./_docs/list.md,./_docs/list.json"). For other commands: base directory location for operations',type:"string"}).argv;function w(e,o){let r=e.map(e=>({name:e.name,url:e.html_url,description:e.description||"",created_at:e.created_at,updated_at:e.updated_at}));o.forEach(e=>{let o=v.resolve(e),i=v.dirname(o),c=v.extname(o).toLowerCase();try{if(s(i),".md"===c){let e,a=(e="| sn | name | url | description | created_at | updated_at |\n|----|------|-----|-------------|------------|------------|\n",r.forEach((o,t)=>{let a=o.name||"",s=o.url||"",r=(o.description||"").replace(/\|/g,"\\|"),i=o.created_at?new Date(o.created_at).toISOString().split("T")[0]:"",c=o.updated_at?new Date(o.updated_at).toISOString().split("T")[0]:"";e+=`| ${t+1} | ${a} | ${s} | ${r} | ${i} | ${c} |
`}),e);t(o,a,{overwrite:!0}),console.log(`✅ Markdown table saved to: ${o}`)}else".json"===c?(a(o,r,{overwrite:!0}),console.log(`✅ JSON data saved to: ${o}`)):console.warn(`⚠️  Unsupported file extension: ${c} for ${o}`)}catch(e){console.error(`❌ Failed to save to ${o}:`,e)}})}function k(e,o){let t=v.resolve(o),r=v.dirname(t),i=v.extname(t).toLowerCase();try{s(r),".json"===i?(a(t,e,{overwrite:!0}),console.log(`✅ User data saved to: ${t}`)):console.warn(`⚠️  Only JSON format is supported for user data: ${t}`)}catch(e){console.error(`❌ Failed to save user data to ${t}:`,e)}}(async()=>{try{var o,t;let a,s,v=await c(R.userName??"","github");v||(console.error(`❌ GitHub 계정 정보를 찾을 수 없습니다: ${R.userName}`),console.log(`💡 다음 중 하나를 시도해보세요:`),console.log(`   1. 계정 설정: xgit -e setAccount -n "Full Name" -e "email@example.com" -t "토큰" -u "${R.userName}"`),console.log(`   2. 다른 계정명으로 시도: xgit -e list -u "다른계정명"`),console.log(`   3. 사용 가능한 계정 목록 확인: xgit -e userlist`),process.exit(1)),v.userName=R.userName??v.userName,console.log(`@@@ git account: ${JSON.stringify(v)}`);let _=new e({auth:v.token}),x=(o=R.repoName??"",(s=(s=(t=R.location)&&"./"!==t?t.startsWith("/")?t:`${y()}/${t}`:y()).replace(/\/$/,"")).split("/").pop()!==o&&(s+=`/${o}`),s??"");switch(R.exec){case"list":case"listRepos":try{if(a=await r(_),console.log(`📊 Found ${a.length} repositories for user: ${R.userName}`),R.location&&"./"!==R.location){let e=R.location.split(",").map(e=>e.trim());w(a,e)}else w(a,["./_docs/list.md","./_docs/list.json"]);let e=a.slice(0,10);console.log("\n📋 Repository List (showing first 10):"),e.forEach((e,o)=>{console.log(`${o+1}. ${e.name} - ${e.html_url}`),console.log(`   📝 ${e.description||"No description"}`),console.log(`   📅 Created: ${new Date(e.created_at).toLocaleDateString()}, Updated: ${new Date(e.updated_at).toLocaleDateString()}
`)}),a.length>10&&console.log(`... and ${a.length-10} more repositories (see output files for complete list)`)}catch(e){e?.status===401||e?.message?.includes("Bad credentials")?(console.warn(`⚠️  인증 실패로 계정 '${R.userName}' 건너뜀 - 토큰을 업데이트하거나 계정 설정을 확인하세요`),console.log(`💡 해결 방법: xgit -e setAccount -n "Full Name" -e "email@example.com" -t "새토큰" -u "${R.userName}"`)):e?.status===403?console.warn(`⚠️  권한 부족으로 계정 '${R.userName}' 건너뜀 - API 사용량 한도 초과이거나 저장소 접근 권한이 없습니다`):console.error(`❌ 계정 '${R.userName}' 저장소 목록 조회 중 오류 발생:`,e?.message||e),a=[]}break;case"userlist":try{if(a=await i("github")){let e=Object.keys(a).length;console.log(`📊 Found ${e} users in GitHub account data`),R.location&&"./"!==R.location?k(a,R.location):k(a,"./_docs/users.json"),console.log("\n👥 User List:"),Object.keys(a).forEach((e,o)=>{let t=a[e];console.log(`${o+1}. ${e}`),console.log(`   📧 ${t.email||"No email"}`),console.log(`   👤 ${t.fullName||"No full name"}
`)})}else console.log("❌ No user data found")}catch(e){console.error("사용자 목록 조회 중 오류 발생:",e)}break;case"create":case"createRemoteRepo":console.log(`createRemoteRepo: ${R}`),await n(_,{name:R.repoName??"",description:R.description??"",isPrivate:R.isPrivate??!1});break;case"del":case"deleteRemoteRepo":await d(_,{name:R.repoName??""},v);break;case"setLocalConfig":l({name:R.repoName??"",description:R.description??""},v,x);break;case"clone":case"cloneRepo":p({name:R.repoName??"",description:R.description??""},v,x);break;case"initLocalRepo":m({name:R.repoName??"",description:R.description??""},v,x);break;case"initRepo":console.log("====initRepo"),await u(_,{name:R.repoName??"",description:R.description??"",isPrivate:R.isPrivate??!1},v,x);break;case"push":case"pushRepo":N({name:R.repoName??"",description:R.description??""},v,x);break;case"copy":case"copyRepo":g({name:R.repoName??"",description:R.description??"description",isPrivate:R.isPrivate??!1},v,x);break;case"make":case"makeRepo":$(_,{name:R.repoName??"",description:R.description??"",isPrivate:R.isPrivate??!1},v,x);break;case"remove":case"removeRepo":await f(_,{name:R.repoName??""},v,x);break;case"pull":case"pullRepo":b({name:R.repoName??"",description:R.description??""},v,x);break;case"sync":case"syncRepo":h({name:R.repoName??"",description:R.description??""},v,x)}}catch(e){e?.status===401||e?.message?.includes("Bad credentials")?(console.error(`❌ 인증 실패: GitHub 토큰이 유효하지 않습니다. 계정: ${R.userName}`),console.log(`💡 해결 방법: 새로운 GitHub Personal Access Token을 생성하고 설정하세요`),console.log(`   xgit -e setAccount -n "Full Name" -e "email@example.com" -t "새토큰" -u "${R.userName}"`)):e?.status===403?console.error(`❌ 권한 부족: API 사용량 한도 초과이거나 저장소 접근 권한이 없습니다. 계정: ${R.userName}`):R.userName&&""!==R.userName?(console.error(`❌ 예기치 않은 오류 발생:`,e?.message||e),console.log(`🔧 문제가 지속되면 다음을 확인하세요:`),console.log(`   1. 인터넷 연결 상태`),console.log(`   2. GitHub 서비스 상태`),console.log(`   3. 계정 설정 및 토큰 유효성`)):console.error(`❌ 사용자명이 제공되지 않았습니다. -u 옵션을 사용하여 사용자명을 지정하세요`),process.exit(1)}})();