#!/usr/bin/env node
import{Octokit as e}from"@octokit/rest";import o from"yargs";import{saveFile as t,saveJson as r,makeDir as s}from"jnu-abc";import{findAllRepos as a,findAllUsers as n,findGithubAccount as i,createRemoteRepo as l,setLocalConfig as c,cloneRepo as p,initLocalRepo as u,deleteRemoteRepo as d,initRepo as m,copyRepo as g,pushRepo as f,makeRepo as b,removeRepo as $,pullRepo as w,syncRepo as N,listRepoIssues as h,createRepoIssue as y,updateRepoIssue as k,listRepoProjects as j,createRepoProject as v,createProjectColumn as _,createProjectCard as P,listRepoWorkflows as x,listWorkflowRuns as I,dispatchWorkflow as R}from"./git.js";import{getCurrentDir as q}from"./cli.js";import C from"path";let A=o.usage("Usage: -e <exec> -u <userName> -n <repoName> [options]").option("e",{alias:"exec",default:"copyRepo",describe:"exec command: copyRepo(clone+config)/makeRepo(create+push)/removeRepo(delete)/pull(fetch latest)/sync(auto commit+push+pull)/list(repos)/listAll(all accounts repos)/userlist(users)/issues:list/issues:create/issues:update/projects:list/projects:create/projects:create-column/projects:create-card/actions:list-workflows/actions:list-runs/actions:dispatch",type:"string",demandOption:!0}).option("u",{alias:"userName",default:"mooninlearn",describe:"GitHub user or organization name",type:"string"}).option("n",{alias:"repoName",describe:"Target repository name",type:"string"}).option("p",{alias:"isPrivate",default:!1,describe:"Create repository as private",type:"boolean"}).option("s",{alias:"src",default:"local",describe:"Source of Github Account metadata (local/github)",type:"string"}).option("d",{alias:"description",describe:"General description for repo/project operations",type:"string"}).option("l",{alias:"location",default:"./",describe:"For list commands: comma-separated output files. Otherwise: base directory for repo tasks",type:"string"}).option("title",{describe:"Title for issues, projects, or columns",type:"string"}).option("body",{describe:"Body/description for issues or projects",type:"string"}).option("labels",{describe:"Comma-separated label names",type:"string"}).option("assignees",{describe:"Comma-separated GitHub usernames to assign",type:"string"}).option("assignee",{describe:"Single assignee login for filtering issue lists",type:"string"}).option("milestone",{describe:"Milestone number for issue create/update",type:"number"}).option("issue-number",{describe:"Issue number for update operations",type:"number"}).option("state",{describe:"State filter (open|closed|all)",type:"string"}).option("per-page",{describe:"Pagination size for list APIs",type:"number"}).option("page",{describe:"Pagination page for list APIs",type:"number"}).option("project-name",{describe:"Project title for project create commands",type:"string"}).option("column-name",{describe:"Project column name for column create",type:"string"}).option("project-id",{describe:"Numeric project ID for column/card operations",type:"number"}).option("column-id",{describe:"Numeric column ID for card operations",type:"number"}).option("note",{describe:"Note content for project cards",type:"string"}).option("content-id",{describe:"GitHub content ID (issue/pull) for project cards",type:"number"}).option("content-type",{describe:"Content type for project cards ('Issue' or 'PullRequest')",type:"string"}).option("workflow-id",{describe:"Workflow file ID or filename for Actions commands",type:"string"}).option("ref",{describe:"Git reference (branch/tag) for workflow dispatch",type:"string"}).option("inputs",{describe:"JSON string of workflow dispatch inputs",type:"string"}).option("branch",{describe:"Branch filter for workflow runs",type:"string"}).option("status",{describe:"Status filter for workflow runs",type:"string"}).argv,S=e=>{if(e)return e.split(",").map(e=>e.trim()).filter(Boolean)},O=e=>{if(!e)return;let o=e.trim();return/^\d+$/.test(o)?Number(o):o},L=["open","closed","all"],G=e=>{if(!e)return;let o=e.toLowerCase();return L.includes(o)?o:void 0},D=["open","closed"],E=["completed","action_required","cancelled","failure","neutral","success","skipped","stale","in_progress","queued","requested","waiting","pending"];function U(e,o){let a=e.map(e=>({name:e.name,url:e.html_url,description:e.description||"",created_at:e.created_at,updated_at:e.updated_at}));o.forEach(e=>{let o=C.resolve(e),n=C.dirname(o),i=C.extname(o).toLowerCase();try{if(s(n),".md"===i){let e=function(e){let o=e.length>0&&"account_name"in e[0],t=o?"| sn | account | name | url | description | created_at | updated_at |\n":"| sn | name | url | description | created_at | updated_at |\n";return t+=o?"|----|---------|------|-----|-------------|------------|------------|\n":"|----|------|-----|-------------|------------|------------|\n",e.forEach((e,r)=>{let s=r+1,a=e.name||"",n=e.url||"",i=(e.description||"").replace(/\|/g,"\\|"),l=e.created_at?new Date(e.created_at).toISOString().split("T")[0]:"",c=e.updated_at?new Date(e.updated_at).toISOString().split("T")[0]:"";if(o){let o=e.account_name||"";t+=`| ${s} | ${o} | ${a} | ${n} | ${i} | ${l} | ${c} |
`}else t+=`| ${s} | ${a} | ${n} | ${i} | ${l} | ${c} |
`}),t}(a);t(o,e,{overwrite:!0}),console.log(`âœ… Markdown table saved to: ${o}`)}else".json"===i?(r(o,a,{overwrite:!0}),console.log(`âœ… JSON data saved to: ${o}`)):console.warn(`âš ï¸  Unsupported file extension: ${i} for ${o}`)}catch(e){console.error(`âŒ Failed to save to ${o}:`,e)}})}function F(e,o){let t=C.resolve(o),a=C.dirname(t),n=C.extname(t).toLowerCase();try{s(a),".json"===n?(r(t,e,{overwrite:!0}),console.log(`âœ… User data saved to: ${t}`)):console.warn(`âš ï¸  Only JSON format is supported for user data: ${t}`)}catch(e){console.error(`âŒ Failed to save user data to ${t}:`,e)}}(async()=>{try{var o,t;let r,s,C=await i(A.userName??"","github");C||(console.error(`âŒ GitHub ê³„ì • ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${A.userName}`),console.log(`ğŸ’¡ ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”:`),console.log(`   1. ê³„ì • ì„¤ì •: xgit -e setAccount -n "Full Name" -e "email@example.com" -t "í† í°" -u "${A.userName}"`),console.log(`   2. ë‹¤ë¥¸ ê³„ì •ëª…ìœ¼ë¡œ ì‹œë„: xgit -e list -u "ë‹¤ë¥¸ê³„ì •ëª…"`),console.log(`   3. ì‚¬ìš© ê°€ëŠ¥í•œ ê³„ì • ëª©ë¡ í™•ì¸: xgit -e userlist`),process.exit(1)),console.log(`@@@ git account: ${JSON.stringify(C)}`);let L=new e({auth:C.token}),H=(o=A.repoName??"",(s=(s=(t=A.location)&&"./"!==t?t.startsWith("/")?t:`${q()}/${t}`:q()).replace(/\/$/,"")).split("/").pop()!==o&&(s+=`/${o}`),s??"");switch(A.exec){case"list":case"listRepos":try{if(r=await a(L),console.log(`ğŸ“Š Found ${r.length} repositories for user: ${A.userName}`),A.location&&"./"!==A.location){let e=A.location.split(",").map(e=>e.trim());U(r,e)}else U(r,["./_docs/list.md","./_docs/list.json"]);let e=r.slice(0,10);console.log("\nğŸ“‹ Repository List (showing first 10):"),e.forEach((e,o)=>{console.log(`${o+1}. ${e.name} - ${e.html_url}`),console.log(`   ğŸ“ ${e.description||"No description"}`),console.log(`   ğŸ“… Created: ${new Date(e.created_at).toLocaleDateString()}, Updated: ${new Date(e.updated_at).toLocaleDateString()}
`)}),r.length>10&&console.log(`... and ${r.length-10} more repositories (see output files for complete list)`)}catch(e){e?.status===401||e?.message?.includes("Bad credentials")?(console.warn(`âš ï¸  ì¸ì¦ ì‹¤íŒ¨ë¡œ ê³„ì • '${A.userName}' ê±´ë„ˆëœ€ - í† í°ì„ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ê³„ì • ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”`),console.log(`ğŸ’¡ í•´ê²° ë°©ë²•: xgit -e setAccount -n "Full Name" -e "email@example.com" -t "ìƒˆí† í°" -u "${A.userName}"`)):e?.status===403?console.warn(`âš ï¸  ê¶Œí•œ ë¶€ì¡±ìœ¼ë¡œ ê³„ì • '${A.userName}' ê±´ë„ˆëœ€ - API ì‚¬ìš©ëŸ‰ í•œë„ ì´ˆê³¼ì´ê±°ë‚˜ ì €ì¥ì†Œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤`):console.error(`âŒ ê³„ì • '${A.userName}' ì €ì¥ì†Œ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:`,e?.message||e),r=[]}break;case"userlist":try{if(r=await n("github")){let e=Object.keys(r).length;console.log(`ğŸ“Š Found ${e} users in GitHub account data`),A.location&&"./"!==A.location?F(r,A.location):F(r,"./_docs/users.json"),console.log("\nğŸ‘¥ User List:"),Object.keys(r).forEach((e,o)=>{let t=r[e];console.log(`${o+1}. ${e}`),console.log(`   ğŸ“§ ${t.email||"No email"}`),console.log(`   ğŸ‘¤ ${t.fullName||"No full name"}
`)})}else console.log("âŒ No user data found")}catch(e){console.error("ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",e)}break;case"listAll":case"listAllRepos":try{let o=await n("github");if(!o){console.log("âŒ No user data found");break}let t=Object.keys(o);console.log(`ğŸ” ëª¨ë“  ê³„ì • ì €ì¥ì†Œ ì¡°íšŒ ì‹œì‘... (ì´ ${t.length}ê°œ ê³„ì •)`);let r=[],s=0,i=0;for(let n of t){let t=o[n];console.log(`
ğŸ“¡ ${n} (${t.email}) ì²˜ë¦¬ ì¤‘...`);try{let o=new e({auth:t.token}),i=await a(o),l=i.map(e=>({...e,account_name:n,account_email:t.email,account_full_name:t.fullName}));r=r.concat(l),s++,console.log(`   âœ… ${i.length}ê°œ ì €ì¥ì†Œ ì¡°íšŒ ì™„ë£Œ`)}catch(e){i++,e?.status===401||e?.message?.includes("Bad credentials")?console.log(`   âš ï¸  í† í° ì¸ì¦ ì‹¤íŒ¨ - ê±´ë„ˆëœ€`):e?.status===403?console.log(`   âš ï¸  ê¶Œí•œ ë¶€ì¡± - ê±´ë„ˆëœ€`):console.log(`   âŒ ì˜¤ë¥˜ ë°œìƒ: ${e?.message||"Unknown error"}`)}}if(console.log(`
ğŸ“Š ì¡°íšŒ ì™„ë£Œ: ì„±ê³µ ${s}ê°œ, ì‹¤íŒ¨ ${i}ê°œ ê³„ì •`),console.log(`ğŸ“¦ ì´ ${r.length}ê°œ ì €ì¥ì†Œ ë°œê²¬`),r.length>0){let e=A.location&&"./"!==A.location?A.location.split(",").map(e=>e.trim()):["./_docs/all-repos.md","./_docs/all-repos.json"];U(r,e),console.log("\nğŸ“‹ ê³„ì •ë³„ ì €ì¥ì†Œ ìˆ˜:");let o={};r.forEach(e=>{let t=e.account_name;o[t]=(o[t]||0)+1}),Object.entries(o).sort(([,e],[,o])=>o-e).forEach(([e,o],t)=>{console.log(`${t+1}. ${e}: ${o}ê°œ`)})}else console.log("âŒ ì¡°íšŒëœ ì €ì¥ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.")}catch(e){console.error("ëª¨ë“  ê³„ì • ì €ì¥ì†Œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",e)}break;case"create":case"createRemoteRepo":console.log(`createRemoteRepo: ${A}`),await l(L,{name:A.repoName??"",description:A.description??"",isPrivate:A.isPrivate??!1});break;case"del":case"deleteRemoteRepo":await d(L,{name:A.repoName??""},C);break;case"setLocalConfig":c({name:A.repoName??"",description:A.description??""},C,H);break;case"clone":case"cloneRepo":p({name:A.repoName??"",description:A.description??""},C,H);break;case"initLocalRepo":u({name:A.repoName??"",description:A.description??""},C,H);break;case"initRepo":console.log("====initRepo"),await m(L,{name:A.repoName??"",description:A.description??"",isPrivate:A.isPrivate??!1},C,H);break;case"push":case"pushRepo":f({name:A.repoName??"",description:A.description??""},C,H);break;case"copy":case"copyRepo":g({name:A.repoName??"",description:A.description??"description",isPrivate:A.isPrivate??!1},C,H);break;case"make":case"makeRepo":b(L,{name:A.repoName??"",description:A.description??"",isPrivate:A.isPrivate??!1},C,H);break;case"remove":case"removeRepo":await $(L,{name:A.repoName??""},C,H);break;case"pull":case"pullRepo":w({name:A.repoName??"",description:A.description??""},C,H);break;case"sync":case"syncRepo":N({name:A.repoName??"",description:A.description??""},C,H);break;case"issues:list":case"issueList":{A.repoName||(console.error("âŒ repoName (-n) is required for issue commands."),process.exit(1));let e=A.repoName,o=G(A.state);A.state&&!o&&console.warn(`âš ï¸  Unknown issue state "${A.state}". Using default.`);let t=S(A.labels),r=A.assignee,s=await h(L,{owner:C.userName,repo:e,state:o,labels:t,assignee:r,perPage:A.perPage,page:A.page});console.log(`ğŸ“‹ Issues for ${e}: ${s.length} found`),s.slice(0,Math.min(s.length,10)).forEach((e,o)=>{console.log(`${o+1}. #${e.number} [${e.state}] ${e.title}`),console.log(`   url: ${e.html_url}`)}),s.length>10&&console.log(`... ${s.length-10} more issues (use --page/--per-page to paginate)`);break}case"issues:create":case"issueCreate":{A.repoName||(console.error("âŒ repoName (-n) is required for issue commands."),process.exit(1)),A.title||(console.error("âŒ title (--title) is required to create an issue."),process.exit(1));let e=A.repoName,o=S(A.labels),t=S(A.assignees),r=await y(L,{owner:C.userName,repo:e,title:A.title,body:A.body??A.description,labels:o,assignees:t,milestone:A.milestone});console.log(`âœ… Issue #${r.number} created: ${r.html_url}`);break}case"issues:update":case"issueUpdate":{let e;A.repoName||(console.error("âŒ repoName (-n) is required for issue commands."),process.exit(1)),"number"!=typeof A.issueNumber&&(console.error("âŒ issue number (--issue-number) is required for issue updates."),process.exit(1));let o=A.repoName,t=S(A.labels),r=S(A.assignees),s=G(A.state);A.state&&(s&&"all"!==s?e=s:console.warn(`âš ï¸  Issue state must be 'open' or 'closed' for updates. Ignoring value: ${A.state}`));let a=void 0!==A.milestone?A.milestone>=0?A.milestone:null:void 0,n=await k(L,{owner:C.userName,repo:o,issueNumber:A.issueNumber,title:A.title,body:A.body??A.description,state:e,labels:t,assignees:r,milestone:a});console.log(`âœ… Issue #${n.number} updated: ${n.html_url}`);break}case"projects:list":case"projectList":{A.repoName||(console.error("âŒ repoName (-n) is required for project commands."),process.exit(1));let e=A.repoName,o=[];if(A.state&&"all"===A.state.toLowerCase()){let[t,r]=await Promise.all([j(L,{owner:C.userName,repo:e,state:"open",perPage:A.perPage}),j(L,{owner:C.userName,repo:e,state:"closed",perPage:A.perPage})]);o=[...t,...r]}else{let t=(e=>{if(!e)return;let o=e.toLowerCase();return D.includes(o)?o:void 0})(A.state);A.state&&!t&&console.warn(`âš ï¸  Project state must be 'open', 'closed', or 'all'. Ignoring value: ${A.state}`),o=await j(L,{owner:C.userName,repo:e,state:t,perPage:A.perPage})}console.log(`ğŸ“‚ Projects for ${e}: ${o.length} found`),o.forEach((e,o)=>{console.log(`${o+1}. [${e.state}] ${e.name} (id: ${e.id})`),e.html_url&&console.log(`   url: ${e.html_url}`)});break}case"projects:create":case"projectCreate":{A.repoName||(console.error("âŒ repoName (-n) is required for project commands."),process.exit(1));let e=A.projectName||A.title;e||(console.error("âŒ Provide a project name via --project-name or --title."),process.exit(1));let o=await v(L,{owner:C.userName,repo:A.repoName,name:e,body:A.body??A.description});console.log(`âœ… Project created: ${o.name} (id: ${o.id})`),o.html_url&&console.log(`   url: ${o.html_url}`);break}case"projects:create-column":case"projectCreateColumn":{"number"!=typeof A.projectId&&(console.error("âŒ project id (--project-id) is required for column creation."),process.exit(1));let e=A.columnName||A.title;e||(console.error("âŒ Column name is required via --column-name or --title."),process.exit(1));let o=await _(L,{projectId:A.projectId,name:e});console.log(`âœ… Column created: ${o.name} (id: ${o.id})`);break}case"projects:create-card":case"projectCreateCard":{"number"!=typeof A.columnId&&(console.error("âŒ column id (--column-id) is required for card creation."),process.exit(1)),A.note||void 0!==A.contentId||(console.error("âŒ Provide either --note or both --content-id and --content-type for project cards."),process.exit(1));let e=(e=>{if(!e)return;let o=e.toLowerCase();return"issue"===o?"Issue":"pullrequest"===o||"pull_request"===o||"pr"===o?"PullRequest":void 0})(A.contentType);void 0===A.contentId||e||(console.error("âŒ --content-type must be Issue or PullRequest when --content-id is supplied."),process.exit(1));let o=await P(L,{columnId:A.columnId,note:A.note,contentId:A.contentId,contentType:e});console.log(`âœ… Card created in column ${A.columnId} (id: ${o.id})`);break}case"actions:list-workflows":case"actions:listWorkflows":case"workflow:list":{A.repoName||(console.error("âŒ repoName (-n) is required for Actions commands."),process.exit(1));let e=await x(L,{owner:C.userName,repo:A.repoName,perPage:A.perPage,page:A.page});if(!e||0===e.length){console.log(`â„¹ï¸  No workflows found for ${A.repoName}.`);break}e.forEach(e=>{console.log(`#${e.id} ${e.name} [${e.state}] - ${e.path}`)});break}case"actions:list-runs":case"actions:listRuns":case"workflow:runs":{A.repoName||(console.error("âŒ repoName (-n) is required for Actions commands."),process.exit(1));let e=(e=>{if(!e)return;let o=e.toLowerCase();return E.includes(o)?o:void 0})(A.status);A.status&&!e&&console.warn(`âš ï¸  Unknown workflow status "${A.status}". Ignoring filter.`);let o=O(A.workflowId),t=await I(L,{owner:C.userName,repo:A.repoName,workflowId:o,branch:A.branch,status:e,perPage:A.perPage,page:A.page});if(!t||0===t.length){console.log(`â„¹ï¸  No workflow runs found for ${A.repoName}.`);break}t.forEach(e=>{let o=e.conclusion?`/${e.conclusion}`:"";console.log(`#${e.id} ${e.name} @ ${e.head_branch} [${e.status}${o}]`),console.log(`   event=${e.event} updated=${e.updated_at}`),console.log(`   url: ${e.html_url}`)});break}case"actions:dispatch":case"workflow:dispatch":{let e;A.repoName||(console.error("âŒ repoName (-n) is required for Actions commands."),process.exit(1));let o=O(A.workflowId);if(o||(console.error("âŒ workflow id (--workflow-id) is required for dispatch."),process.exit(1)),A.ref||(console.error("âŒ ref (--ref) is required for workflow dispatch."),process.exit(1)),A.inputs)try{let o=JSON.parse(A.inputs);o&&"object"==typeof o&&!Array.isArray(o)?e=o:(console.error("âŒ --inputs must be a JSON object."),process.exit(1))}catch(e){console.error(`âŒ Failed to parse --inputs JSON: ${e?.message||e}`),process.exit(1)}await R(L,{owner:C.userName,repo:A.repoName,workflowId:o,ref:A.ref,inputs:e}),console.log(`âœ… Workflow dispatched for ${A.repoName} (${String(o)}) on ${A.ref}`)}}}catch(e){e?.status===401||e?.message?.includes("Bad credentials")?(console.error(`âŒ ì¸ì¦ ì‹¤íŒ¨: GitHub í† í°ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê³„ì •: ${A.userName}`),console.log(`ğŸ’¡ í•´ê²° ë°©ë²•: ìƒˆë¡œìš´ GitHub Personal Access Tokenì„ ìƒì„±í•˜ê³  ì„¤ì •í•˜ì„¸ìš”`),console.log(`   xgit -e setAccount -n "Full Name" -e "email@example.com" -t "ìƒˆí† í°" -u "${A.userName}"`)):e?.status===403?console.error(`âŒ ê¶Œí•œ ë¶€ì¡±: API ì‚¬ìš©ëŸ‰ í•œë„ ì´ˆê³¼ì´ê±°ë‚˜ ì €ì¥ì†Œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê³„ì •: ${A.userName}`):A.userName&&""!==A.userName?(console.error(`âŒ ì˜ˆê¸°ì¹˜ ì•Šì€ ì˜¤ë¥˜ ë°œìƒ:`,e?.message||e),console.log(`ğŸ”§ ë¬¸ì œê°€ ì§€ì†ë˜ë©´ ë‹¤ìŒì„ í™•ì¸í•˜ì„¸ìš”:`),console.log(`   1. ì¸í„°ë„· ì—°ê²° ìƒíƒœ`),console.log(`   2. GitHub ì„œë¹„ìŠ¤ ìƒíƒœ`),console.log(`   3. ê³„ì • ì„¤ì • ë° í† í° ìœ íš¨ì„±`)):console.error(`âŒ ì‚¬ìš©ìëª…ì´ ì œê³µë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. -u ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ì‚¬ìš©ìëª…ì„ ì§€ì •í•˜ì„¸ìš”`),process.exit(1)}})();