#!/usr/bin/env node
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const e=require("@octokit/rest"),o=/*#__PURE__*/n(require("yargs")),t=require("jnu-abc"),r=require("./git.js"),s=require("./cli.js"),a=/*#__PURE__*/n(require("path"));function n(e){return e&&e.__esModule?e:{default:e}}const i=o.default.usage("Usage: -e <exec> -u <userName> -n <repoName> [options]").option("e",{alias:"exec",default:"copyRepo",describe:"exec command: copyRepo(clone+config)/makeRepo(create+push)/removeRepo(delete)/pull(fetch latest)/sync(auto commit+push+pull)/list(repos)/listAll(all accounts repos)/userlist(users)/issues:list/issues:create/issues:update/projects:list/projects:create/projects:create-column/projects:create-card/actions:list-workflows/actions:list-runs/actions:dispatch",type:"string",demandOption:!0}).option("u",{alias:"userName",default:"mooninlearn",describe:"GitHub user or organization name",type:"string"}).option("n",{alias:"repoName",describe:"Target repository name",type:"string"}).option("p",{alias:"isPrivate",default:!1,describe:"Create repository as private",type:"boolean"}).option("s",{alias:"src",default:"local",describe:"Source of Github Account metadata (local/github)",type:"string"}).option("d",{alias:"description",describe:"General description for repo/project operations",type:"string"}).option("l",{alias:"location",default:"./",describe:"For list commands: comma-separated output files. Otherwise: base directory for repo tasks",type:"string"}).option("title",{describe:"Title for issues, projects, or columns",type:"string"}).option("body",{describe:"Body/description for issues or projects",type:"string"}).option("labels",{describe:"Comma-separated label names",type:"string"}).option("assignees",{describe:"Comma-separated GitHub usernames to assign",type:"string"}).option("assignee",{describe:"Single assignee login for filtering issue lists",type:"string"}).option("milestone",{describe:"Milestone number for issue create/update",type:"number"}).option("issue-number",{describe:"Issue number for update operations",type:"number"}).option("state",{describe:"State filter (open|closed|all)",type:"string"}).option("per-page",{describe:"Pagination size for list APIs",type:"number"}).option("page",{describe:"Pagination page for list APIs",type:"number"}).option("project-name",{describe:"Project title for project create commands",type:"string"}).option("column-name",{describe:"Project column name for column create",type:"string"}).option("project-id",{describe:"Numeric project ID for column/card operations",type:"number"}).option("column-id",{describe:"Numeric column ID for card operations",type:"number"}).option("note",{describe:"Note content for project cards",type:"string"}).option("content-id",{describe:"GitHub content ID (issue/pull) for project cards",type:"number"}).option("content-type",{describe:"Content type for project cards ('Issue' or 'PullRequest')",type:"string"}).option("workflow-id",{describe:"Workflow file ID or filename for Actions commands",type:"string"}).option("ref",{describe:"Git reference (branch/tag) for workflow dispatch",type:"string"}).option("inputs",{describe:"JSON string of workflow dispatch inputs",type:"string"}).option("branch",{describe:"Branch filter for workflow runs",type:"string"}).option("status",{describe:"Status filter for workflow runs",type:"string"}).argv,l=e=>{if(e)return e.split(",").map(e=>e.trim()).filter(Boolean)},c=e=>{if(!e)return;let o=e.trim();return/^\d+$/.test(o)?Number(o):o},p=["open","closed","all"],u=e=>{if(!e)return;let o=e.toLowerCase();return p.includes(o)?o:void 0},d=["open","closed"],m=["completed","action_required","cancelled","failure","neutral","success","skipped","stale","in_progress","queued","requested","waiting","pending"];function g(e,o){let r=e.map(e=>({name:e.name,url:e.html_url,description:e.description||"",created_at:e.created_at,updated_at:e.updated_at}));o.forEach(e=>{let o=a.default.resolve(e),s=a.default.dirname(o),n=a.default.extname(o).toLowerCase();try{if((0,t.makeDir)(s),".md"===n){let e=function(e){let o=e.length>0&&"account_name"in e[0],t=o?"| sn | account | name | url | description | created_at | updated_at |\n":"| sn | name | url | description | created_at | updated_at |\n";return t+=o?"|----|---------|------|-----|-------------|------------|------------|\n":"|----|------|-----|-------------|------------|------------|\n",e.forEach((e,r)=>{let s=r+1,a=e.name||"",n=e.url||"",i=(e.description||"").replace(/\|/g,"\\|"),l=e.created_at?new Date(e.created_at).toISOString().split("T")[0]:"",c=e.updated_at?new Date(e.updated_at).toISOString().split("T")[0]:"";if(o){let o=e.account_name||"";t+=`| ${s} | ${o} | ${a} | ${n} | ${i} | ${l} | ${c} |
`}else t+=`| ${s} | ${a} | ${n} | ${i} | ${l} | ${c} |
`}),t}(r);(0,t.saveFile)(o,e,{overwrite:!0}),console.log(`✅ Markdown table saved to: ${o}`)}else".json"===n?((0,t.saveJson)(o,r,{overwrite:!0}),console.log(`✅ JSON data saved to: ${o}`)):console.warn(`⚠️  Unsupported file extension: ${n} for ${o}`)}catch(e){console.error(`❌ Failed to save to ${o}:`,e)}})}function f(e,o){let r=a.default.resolve(o),s=a.default.dirname(r),n=a.default.extname(r).toLowerCase();try{(0,t.makeDir)(s),".json"===n?((0,t.saveJson)(r,e,{overwrite:!0}),console.log(`✅ User data saved to: ${r}`)):console.warn(`⚠️  Only JSON format is supported for user data: ${r}`)}catch(e){console.error(`❌ Failed to save user data to ${r}:`,e)}}(async()=>{try{var o,t;let a,n,p=await (0,r.findGithubAccount)(i.userName??"","github");p||(console.error(`❌ GitHub 계정 정보를 찾을 수 없습니다: ${i.userName}`),console.log(`💡 다음 중 하나를 시도해보세요:`),console.log(`   1. 계정 설정: xgit -e setAccount -n "Full Name" -e "email@example.com" -t "토큰" -u "${i.userName}"`),console.log(`   2. 다른 계정명으로 시도: xgit -e list -u "다른계정명"`),console.log(`   3. 사용 가능한 계정 목록 확인: xgit -e userlist`),process.exit(1));let b=p.userName??i.userName??"";b||(console.error("❌ 사용할 GitHub 계정 또는 저장소 소유자 정보를 확인할 수 없습니다."),console.log("💡 -u 옵션으로 계정명을 전달했는지 확인하거나 계정 설정을 갱신하세요."),process.exit(1)),console.log(`@@@ git account: ${JSON.stringify({userName:b,fullName:p.fullName,email:p.email})}`);let $=new e.Octokit({auth:p.token}),w=(o=i.repoName??"",(n=(n=(t=i.location)&&"./"!==t?t.startsWith("/")?t:`${(0,s.getCurrentDir)()}/${t}`:(0,s.getCurrentDir)()).replace(/\/$/,"")).split("/").pop()!==o&&(n+=`/${o}`),n??"");switch(i.exec){case"list":case"listRepos":try{if(a=await (0,r.findAllRepos)($),console.log(`📊 Found ${a.length} repositories for user: ${i.userName}`),i.location&&"./"!==i.location){let e=i.location.split(",").map(e=>e.trim());g(a,e)}else g(a,["./_docs/list.md","./_docs/list.json"]);let e=a.slice(0,10);console.log("\n📋 Repository List (showing first 10):"),e.forEach((e,o)=>{console.log(`${o+1}. ${e.name} - ${e.html_url}`),console.log(`   📝 ${e.description||"No description"}`),console.log(`   📅 Created: ${new Date(e.created_at).toLocaleDateString()}, Updated: ${new Date(e.updated_at).toLocaleDateString()}
`)}),a.length>10&&console.log(`... and ${a.length-10} more repositories (see output files for complete list)`)}catch(e){e?.status===401||e?.message?.includes("Bad credentials")?(console.warn(`⚠️  인증 실패로 계정 '${i.userName}' 건너뜀 - 토큰을 업데이트하거나 계정 설정을 확인하세요`),console.log(`💡 해결 방법: xgit -e setAccount -n "Full Name" -e "email@example.com" -t "새토큰" -u "${i.userName}"`)):e?.status===403?console.warn(`⚠️  권한 부족으로 계정 '${i.userName}' 건너뜀 - API 사용량 한도 초과이거나 저장소 접근 권한이 없습니다`):console.error(`❌ 계정 '${i.userName}' 저장소 목록 조회 중 오류 발생:`,e?.message||e),a=[]}break;case"userlist":try{if(a=await (0,r.findAllUsers)("github")){let e=Object.keys(a).length;console.log(`📊 Found ${e} users in GitHub account data`),i.location&&"./"!==i.location?f(a,i.location):f(a,"./_docs/users.json"),console.log("\n👥 User List:"),Object.keys(a).forEach((e,o)=>{let t=a[e];console.log(`${o+1}. ${e}`),console.log(`   📧 ${t.email||"No email"}`),console.log(`   👤 ${t.fullName||"No full name"}
`)})}else console.log("❌ No user data found")}catch(e){console.error("사용자 목록 조회 중 오류 발생:",e)}break;case"listAll":case"listAllRepos":try{let o=await (0,r.findAllUsers)("github");if(!o){console.log("❌ No user data found");break}let t=Object.keys(o);console.log(`🔍 모든 계정 저장소 조회 시작... (총 ${t.length}개 계정)`);let s=[],a=0,n=0;for(let i of t){let t=o[i];console.log(`
📡 ${i} (${t.email}) 처리 중...`);try{let o=new e.Octokit({auth:t.token}),n=await (0,r.findAllRepos)(o),l=n.map(e=>({...e,account_name:i,account_email:t.email,account_full_name:t.fullName}));s=s.concat(l),a++,console.log(`   ✅ ${n.length}개 저장소 조회 완료`)}catch(e){n++,e?.status===401||e?.message?.includes("Bad credentials")?console.log(`   ⚠️  토큰 인증 실패 - 건너뜀`):e?.status===403?console.log(`   ⚠️  권한 부족 - 건너뜀`):console.log(`   ❌ 오류 발생: ${e?.message||"Unknown error"}`)}}if(console.log(`
📊 조회 완료: 성공 ${a}개, 실패 ${n}개 계정`),console.log(`📦 총 ${s.length}개 저장소 발견`),s.length>0){let e=i.location&&"./"!==i.location?i.location.split(",").map(e=>e.trim()):["./_docs/all-repos.md","./_docs/all-repos.json"];g(s,e),console.log("\n📋 계정별 저장소 수:");let o={};s.forEach(e=>{let t=e.account_name;o[t]=(o[t]||0)+1}),Object.entries(o).sort(([,e],[,o])=>o-e).forEach(([e,o],t)=>{console.log(`${t+1}. ${e}: ${o}개`)})}else console.log("❌ 조회된 저장소가 없습니다.")}catch(e){console.error("모든 계정 저장소 조회 중 오류 발생:",e)}break;case"create":case"createRemoteRepo":console.log(`createRemoteRepo: ${i}`),await (0,r.createRemoteRepo)($,{name:i.repoName??"",description:i.description??"",isPrivate:i.isPrivate??!1});break;case"del":case"deleteRemoteRepo":await (0,r.deleteRemoteRepo)($,{name:i.repoName??""},p);break;case"setLocalConfig":(0,r.setLocalConfig)({name:i.repoName??"",description:i.description??""},p,w);break;case"clone":case"cloneRepo":(0,r.cloneRepo)({name:i.repoName??"",description:i.description??""},p,w);break;case"initLocalRepo":(0,r.initLocalRepo)({name:i.repoName??"",description:i.description??""},p,w);break;case"initRepo":console.log("====initRepo"),await (0,r.initRepo)($,{name:i.repoName??"",description:i.description??"",isPrivate:i.isPrivate??!1},p,w);break;case"push":case"pushRepo":(0,r.pushRepo)({name:i.repoName??"",description:i.description??""},p,w);break;case"copy":case"copyRepo":(0,r.copyRepo)({name:i.repoName??"",description:i.description??"description",isPrivate:i.isPrivate??!1},p,w);break;case"make":case"makeRepo":(0,r.makeRepo)($,{name:i.repoName??"",description:i.description??"",isPrivate:i.isPrivate??!1},p,w);break;case"remove":case"removeRepo":await (0,r.removeRepo)($,{name:i.repoName??""},p,w);break;case"pull":case"pullRepo":(0,r.pullRepo)({name:i.repoName??"",description:i.description??""},p,w);break;case"sync":case"syncRepo":(0,r.syncRepo)({name:i.repoName??"",description:i.description??""},p,w);break;case"issues:list":case"issueList":{i.repoName||(console.error("❌ repoName (-n) is required for issue commands."),process.exit(1));let e=i.repoName,o=u(i.state);i.state&&!o&&console.warn(`⚠️  Unknown issue state "${i.state}". Using default.`);let t=l(i.labels),s=i.assignee,a=await (0,r.listRepoIssues)($,{owner:b,repo:e,state:o,labels:t,assignee:s,perPage:i.perPage,page:i.page});console.log(`📋 Issues for ${e}: ${a.length} found`),a.slice(0,Math.min(a.length,10)).forEach((e,o)=>{console.log(`${o+1}. #${e.number} [${e.state}] ${e.title}`),console.log(`   url: ${e.html_url}`)}),a.length>10&&console.log(`... ${a.length-10} more issues (use --page/--per-page to paginate)`);break}case"issues:create":case"issueCreate":{i.repoName||(console.error("❌ repoName (-n) is required for issue commands."),process.exit(1)),i.title||(console.error("❌ title (--title) is required to create an issue."),process.exit(1));let e=i.repoName,o=l(i.labels),t=l(i.assignees),s=await (0,r.createRepoIssue)($,{owner:b,repo:e,title:i.title,body:i.body??i.description,labels:o,assignees:t,milestone:i.milestone});console.log(`✅ Issue #${s.number} created: ${s.html_url}`);break}case"issues:update":case"issueUpdate":{let e;i.repoName||(console.error("❌ repoName (-n) is required for issue commands."),process.exit(1)),"number"!=typeof i.issueNumber&&(console.error("❌ issue number (--issue-number) is required for issue updates."),process.exit(1));let o=i.repoName,t=l(i.labels),s=l(i.assignees),a=u(i.state);i.state&&(a&&"all"!==a?e=a:console.warn(`⚠️  Issue state must be 'open' or 'closed' for updates. Ignoring value: ${i.state}`));let n=void 0!==i.milestone?i.milestone>=0?i.milestone:null:void 0,c=await (0,r.updateRepoIssue)($,{owner:b,repo:o,issueNumber:i.issueNumber,title:i.title,body:i.body??i.description,state:e,labels:t,assignees:s,milestone:n});console.log(`✅ Issue #${c.number} updated: ${c.html_url}`);break}case"projects:list":case"projectList":{i.repoName||(console.error("❌ repoName (-n) is required for project commands."),process.exit(1));let e=i.repoName,o=[];if(i.state&&"all"===i.state.toLowerCase()){let[t,s]=await Promise.all([(0,r.listRepoProjects)($,{owner:b,repo:e,state:"open",perPage:i.perPage}),(0,r.listRepoProjects)($,{owner:b,repo:e,state:"closed",perPage:i.perPage})]);o=[...t,...s]}else{let t=(e=>{if(!e)return;let o=e.toLowerCase();return d.includes(o)?o:void 0})(i.state);i.state&&!t&&console.warn(`⚠️  Project state must be 'open', 'closed', or 'all'. Ignoring value: ${i.state}`),o=await (0,r.listRepoProjects)($,{owner:b,repo:e,state:t,perPage:i.perPage})}console.log(`📂 Projects for ${e}: ${o.length} found`),o.forEach((e,o)=>{console.log(`${o+1}. [${e.state}] ${e.name} (id: ${e.id})`),e.html_url&&console.log(`   url: ${e.html_url}`)});break}case"projects:create":case"projectCreate":{i.repoName||(console.error("❌ repoName (-n) is required for project commands."),process.exit(1));let e=i.projectName||i.title;e||(console.error("❌ Provide a project name via --project-name or --title."),process.exit(1));let o=await (0,r.createRepoProject)($,{owner:b,repo:i.repoName,name:e,body:i.body??i.description});console.log(`✅ Project created: ${o.name} (id: ${o.id})`),o.html_url&&console.log(`   url: ${o.html_url}`);break}case"projects:create-column":case"projectCreateColumn":{"number"!=typeof i.projectId&&(console.error("❌ project id (--project-id) is required for column creation."),process.exit(1));let e=i.columnName||i.title;e||(console.error("❌ Column name is required via --column-name or --title."),process.exit(1));let o=await (0,r.createProjectColumn)($,{projectId:i.projectId,name:e});console.log(`✅ Column created: ${o.name} (id: ${o.id})`);break}case"projects:create-card":case"projectCreateCard":{"number"!=typeof i.columnId&&(console.error("❌ column id (--column-id) is required for card creation."),process.exit(1)),i.note||void 0!==i.contentId||(console.error("❌ Provide either --note or both --content-id and --content-type for project cards."),process.exit(1));let e=(e=>{if(!e)return;let o=e.toLowerCase();return"issue"===o?"Issue":"pullrequest"===o||"pull_request"===o||"pr"===o?"PullRequest":void 0})(i.contentType);void 0===i.contentId||e||(console.error("❌ --content-type must be Issue or PullRequest when --content-id is supplied."),process.exit(1));let o=await (0,r.createProjectCard)($,{columnId:i.columnId,note:i.note,contentId:i.contentId,contentType:e});console.log(`✅ Card created in column ${i.columnId} (id: ${o.id})`);break}case"actions:list-workflows":case"actions:listWorkflows":case"workflow:list":{i.repoName||(console.error("❌ repoName (-n) is required for Actions commands."),process.exit(1));let e=await (0,r.listRepoWorkflows)($,{owner:b,repo:i.repoName,perPage:i.perPage,page:i.page});if(!e||0===e.length){console.log(`ℹ️  No workflows found for ${i.repoName}.`);break}e.forEach(e=>{console.log(`#${e.id} ${e.name} [${e.state}] - ${e.path}`)});break}case"actions:list-runs":case"actions:listRuns":case"workflow:runs":{i.repoName||(console.error("❌ repoName (-n) is required for Actions commands."),process.exit(1));let e=(e=>{if(!e)return;let o=e.toLowerCase();return m.includes(o)?o:void 0})(i.status);i.status&&!e&&console.warn(`⚠️  Unknown workflow status "${i.status}". Ignoring filter.`);let o=c(i.workflowId),t=await (0,r.listWorkflowRuns)($,{owner:b,repo:i.repoName,workflowId:o,branch:i.branch,status:e,perPage:i.perPage,page:i.page});if(!t||0===t.length){console.log(`ℹ️  No workflow runs found for ${i.repoName}.`);break}t.forEach(e=>{let o=e.conclusion?`/${e.conclusion}`:"";console.log(`#${e.id} ${e.name} @ ${e.head_branch} [${e.status}${o}]`),console.log(`   event=${e.event} updated=${e.updated_at}`),console.log(`   url: ${e.html_url}`)});break}case"actions:dispatch":case"workflow:dispatch":{let e;i.repoName||(console.error("❌ repoName (-n) is required for Actions commands."),process.exit(1));let o=c(i.workflowId);if(o||(console.error("❌ workflow id (--workflow-id) is required for dispatch."),process.exit(1)),i.ref||(console.error("❌ ref (--ref) is required for workflow dispatch."),process.exit(1)),i.inputs)try{let o=JSON.parse(i.inputs);o&&"object"==typeof o&&!Array.isArray(o)?e=o:(console.error("❌ --inputs must be a JSON object."),process.exit(1))}catch(e){console.error(`❌ Failed to parse --inputs JSON: ${e?.message||e}`),process.exit(1)}await (0,r.dispatchWorkflow)($,{owner:b,repo:i.repoName,workflowId:o,ref:i.ref,inputs:e}),console.log(`✅ Workflow dispatched for ${i.repoName} (${String(o)}) on ${i.ref}`)}}}catch(e){e?.status===401||e?.message?.includes("Bad credentials")?(console.error(`❌ 인증 실패: GitHub 토큰이 유효하지 않습니다. 계정: ${i.userName}`),console.log(`💡 해결 방법: 새로운 GitHub Personal Access Token을 생성하고 설정하세요`),console.log(`   xgit -e setAccount -n "Full Name" -e "email@example.com" -t "새토큰" -u "${i.userName}"`)):e?.status===403?console.error(`❌ 권한 부족: API 사용량 한도 초과이거나 저장소 접근 권한이 없습니다. 계정: ${i.userName}`):i.userName&&""!==i.userName?(console.error(`❌ 예기치 않은 오류 발생:`,e?.message||e),console.log(`🔧 문제가 지속되면 다음을 확인하세요:`),console.log(`   1. 인터넷 연결 상태`),console.log(`   2. GitHub 서비스 상태`),console.log(`   3. 계정 설정 및 토큰 유효성`)):console.error(`❌ 사용자명이 제공되지 않았습니다. -u 옵션을 사용하여 사용자명을 지정하세요`),process.exit(1)}})();